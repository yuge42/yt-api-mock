# Docker Compose configuration for TLS-enabled YouTube API Mock Server
# This setup uses nginx as a reverse proxy for TLS termination
#
# Usage:
#   1. Generate self-signed certificates (for development):
#      ./nginx/generate-certs.sh
#
#   2. Start the services:
#      docker compose -f docker-compose.tls.yml up --build
#
#   3. Access the services:
#      REST API: https://localhost:8443/youtube/v3/videos?part=liveStreamingDetails&id=test-video-1
#      gRPC: grpcurl -insecure localhost:50051 list
#
# Note: For production, replace the self-signed certificates with proper CA-signed certificates

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - GRPC_BIND_ADDRESS=[::]:50051
      - REST_BIND_ADDRESS=[::]:8080
    networks:
      - yt-api-network
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z localhost 50051 && nc -z localhost 8080 || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  nginx:
    image: nginx:alpine
    ports:
      - "8443:443"    # HTTPS for REST API
      - "50051:50051" # TLS for gRPC
      - "8080:80"     # Optional: HTTP redirect to HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      server:
        condition: service_healthy
    networks:
      - yt-api-network

networks:
  yt-api-network:
    driver: bridge
