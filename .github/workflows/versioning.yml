name: Versioning

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    name: Update Version and Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | \
            sed 's/version = "\(.*\)"/\1/')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"

          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          NEW_VERSION="${major}.${minor}.${patch}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update Cargo.toml workspace version
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          echo "Updated workspace Cargo.toml to version $NEW_VERSION"

      - name: Update server Cargo.toml version
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" \
            server/Cargo.toml
          echo "Updated server/Cargo.toml to version $NEW_VERSION"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Cargo.lock
        run: |
          # Update Cargo.lock to reflect the version changes
          # cargo check will update the lockfile as needed
          cargo check --workspace
          echo "Updated Cargo.lock"

      - name: Create release branch
        id: create_branch
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          BRANCH_NAME="release/v$NEW_VERSION"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"

      - name: Commit version changes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git add Cargo.toml server/Cargo.toml Cargo.lock
          git commit -m "chore: bump version to $NEW_VERSION"
          echo "Committed version changes"

      - name: Push release branch
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch }}"
          git push origin "$BRANCH_NAME"
          echo "Pushed branch: $BRANCH_NAME"

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "Created and pushed tag v$NEW_VERSION"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          BRANCH_NAME="${{ steps.create_branch.outputs.branch }}"

          cat > pr_body.md << 'EOFPR'
          This PR bumps the version to v$VERSION and was created automatically
          by the versioning workflow.

          ## Changes
          - Updated workspace version in Cargo.toml to $VERSION
          - Updated server version in server/Cargo.toml to $VERSION
          - Updated Cargo.lock

          ## Release
          The tag v$VERSION has been created and pushed. The release workflow
          will be automatically triggered after this versioning workflow completes
          successfully to build and publish the Docker image and create a GitHub release.
          EOFPR

          sed -i "s/\$VERSION/$NEW_VERSION/g" pr_body.md

          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore: release v$NEW_VERSION" \
            --body-file pr_body.md

          echo "Created pull request for version $NEW_VERSION"
